<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/TGS-logo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalji korisnika - <%= user.username %></title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/stylesheets/shared/loadingSpinner.css">
    <link rel="stylesheet" href="/stylesheets/shared/topBar.css">
    <link rel="stylesheet" href="/stylesheets/shared/body.css">
    <link rel="stylesheet" href="/stylesheets/admin/userDetails.css">
</head>
<body>
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="bg-fixed"></div>

<div class="top-bar">
    <div class="admin-info">
        <div class="admin-avatar"><%= admin.username.charAt(0).toUpperCase() %></div>
        <span class="admin-name"><%= admin.username %></span>
    </div>
    <div class="nav-actions">
        <a href="/admin" class="back-btn">Admin panel</a>
        <a href="/auth/logout" class="logout-btn">Odjava</a>
    </div>
</div>

<div class="user-details-container">

    <div class="header-card">
        <div class="page-header">
            <h1 class="page-title">Detalji korisnika</h1>
            <a href="/admin/manage-users" class="back-btn">
                <span>Nazad na listu korisnika</span>
            </a>
        </div>
    </div>

    <% if (success) { %>
        <div class="alert alert-success custom-success" role="alert">
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>

            <div class="alert-content">
                <span><%= success %></span>

                <% if (tempPassword) { %>
                    <p class="temp-pass">
                        Privremena lozinka: <b><%= tempPassword %></b>
                    </p>
                <% } %>
            </div>
        </div>
    <% } %>

    <div class="details-grid">
        <div class="details-card">
            <div class="card-header">
                <h2>Opće informacije</h2>
                <a href="/admin/user/edit/<%= user.id %>" class="edit-btn">
                    <i class="fas fa-pencil-alt"></i> Uredi
                </a>
            </div>
            <div class="card-body">
                <div class="info-grid">

                    <div class="info-item">
                        <span class="info-label">Email adresa</span>
                        <span class="info-value"><%= user.email || 'Nije dostupno' %></span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Korisničko ime</span>
                        <span class="info-value"><%= user.username || 'Nije dostupno' %></span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Broj telefona</span>
                        <span class="info-value"><%= user.phone_number || 'Nije dostupno' %></span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Uloga</span>
                        <span class="info-value">
                            <span class="role-badge <%= user.role %>"><%= user.role %></span>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Posljednja prijava</span>
                        <span class="info-value">
                            <%= user.last_login_at ? new Date(user.last_login_at).toLocaleString() : 'Nikada' %>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Profil kreiran</span>
                        <span class="info-value"><%= new Date(user.created_at).toLocaleDateString() %></span>
                    </div>

                </div>
            </div>
        </div>

        <div class="details-card">
            <div class="card-header">
                <h2>Sigurnosti</h2>
            </div>
            <div class="card-body">
                <div class="info-grid">

                    <div class="info-item">
                        <span class="info-label">Status računa</span>
                        <span class="info-value">
                            <% if (user.banned) { %>
                                <span class="status-badge banned">Suspendovan</span>
                            <% } else if (user.is_active) { %>
                                <span class="status-badge active">Aktivan</span>
                            <% } else { %>
                                <span class="status-badge inactive">Neaktivan</span>
                            <% } %>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Zaključavanje</span>
                        <span class="info-value">
                            <% if (user.is_locked) { %>
                                <span class="status-badge banned">Zaključan</span>
                            <% } else { %>
                                <span class="status-badge active">Otključan</span>
                            <% } %>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Zaključan do</span>
                        <span class="info-value">
                            <%= user.locked_until ? new Date(user.locked_until).toLocaleString() : 'N/A' %>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Neuspješnih prijava</span>
                        <span class="info-value"><%= user.failed_login_attempts %></span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Promjena lozinke</span>
                        <span class="info-value">
                            <%= user.must_change_password ? 'Obavezna pri sljedećoj prijavi' : 'Nije obavezna' %>
                        </span>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="details-card">
        <div class="card-header">
            <h2>Upravljanje korisnikom</h2>
        </div>

        <div class="card-body">
            <div class="actions-grid">

                <form method="POST" action="/admin/lock/<%= user.id %>" class="action-form">
                    <label for="lock-minutes">Trajanje zaključavanja (u minutama)</label>
                    <input id="lock-minutes" name="minutes" type="number" placeholder="npr. 60" required>
                    <button type="submit" class="btn-action btn-warning">
                        <i class="fas fa-lock"></i> Zaključaj
                    </button>

                </form>

                <form method="POST" action="/admin/unlock/<%= user.id %>" class="action-form">
                    <p>Ukloni privremeno zaključavanje korisničkog računa.</p>
                    <button type="submit" class="btn-action btn-success" <% if (!user.is_locked) { %> disabled <% } %>>
                        <i class="fas fa-unlock"></i> Otključaj
                    </button>
                </form>

                <% if (user.banned) { %>
                    <form method="POST" action="/admin/unban/<%= user.id %>" class="action-form">
                        <p>Vrati pristup suspendovanom korisniku.</p>
                        <button type="submit" class="btn-action btn-success">
                            <i class="fas fa-check-circle"></i> Aktiviraj korisnika
                        </button>
                    </form>
                <% } else { %>
                    <form method="POST" action="/admin/ban/<%= user.id %>" class="action-form">
                        <p>Trajno onemogući pristup korisniku.</p>
                        <button type="submit" class="btn-action btn-danger">
                            <i class="fas fa-ban"></i> Deaktiviraj korisnika
                        </button>
                    </form>
                <% } %>

                <form method="POST" action="/admin/reset-password/<%= user.id %>" class="action-form">
                    <p>Nametni obaveznu promjenu lozinke pri sljedećoj prijavi.</p>
                    <button type="submit" class="btn-action btn-secondary">
                        <i class="fas fa-key"></i> Resetuj lozinku
                    </button>
                </form>

                <form id="deleteUserForm" method="POST" action="/admin/delete/<%= user.id %>" class="action-form">
                    <p>Trajno obriši korisnika i sve povezane podatke.</p>
                    <button type="button" class="btn-action btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                        <i class="fas fa-trash-alt"></i> Obriši korisnika
                    </button>
                </form>

            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Potvrda brisanja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Jeste li sigurni da želite trajno obrisati ovog korisnika? Ova radnja je nepovratna.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Odustani</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Obriši</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.addEventListener('load', function() {
        document.getElementById('loading-overlay').classList.add('hidden');
    });

    if (window.location.search.includes("success")) {
        const cleanURL = window.location.pathname;
        window.history.replaceState({}, document.title, cleanURL);
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        document.getElementById('deleteUserForm').submit();
    });
</script>

</body>
</html>
