<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/TGS-logo.png" type="image/png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uređivanje menija</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/stylesheets/shared/loadingSpinner.css">
    <link rel="stylesheet" href="/stylesheets/shared/topBar.css">
    <link rel="stylesheet" href="/stylesheets/shared/body.css">
    <link rel="stylesheet" href="/stylesheets/canteen/menu.css">
</head>
<body>
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="bg-fixed"></div>

<div class="top-bar">
    <div class="admin-info">
        <div class="admin-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
        <span class="admin-name"><%= user.username %></span>
    </div>
    <div class="nav-actions">
        <a href="/canteen" class="back-btn">Kantina panel</a>
        <a href="/auth/logout" class="logout-btn">Odjavi se</a>
    </div>
</div>


<div class="menu-container">
    <div class="page-header">
        <div class="page-header-card">
            <h1 class="page-title">Meni</h1>
        </div>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="error-message">
            <span><%= error %></span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>

    <% if (typeof success !== 'undefined' && success) { %>
        <div class="success-message">
            <span><%= success %></span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>

    <div id="menuDisplayContainer">
        <% if (menu && menu.length > 0) { %>
            <div class="menu-display-card">
                <% menu.forEach(item => { %>
                    <div class="menu-item-display">
                        <img src="<%= item.image_url %>" alt="<%= item.name %>" class="item-image-display" onerror="this.onerror=null; this.src='/images/default-food.png';">
                        <div class="item-details-display">
                            <div class="item-name-display"><%= item.name %></div>
                            <div class="item-price-display"><%= item.price %> KM</div>
                            <p class="item-description-display"><%= item.description %></p>
                            <% if (item.Tags && item.Tags.length > 0) { %>
                                <div class="item-tags-display">
                                    <% item.Tags.forEach(tag => { %>
                                        <span class="tag"><%= tag.name %></span>
                                    <% }) %>
                                </div>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
                <div class="menu-actions">
                    <button type="button" class="btn-primary" id="editMenuBtn"><i class="bi bi-pencil-square"></i> Uredi meni</button>
                    <form id="deleteMenuForm" action="/canteen/menu/delete" method="POST" class="d-inline">
                        <button type="button" class="btn-danger" data-bs-toggle="modal" data-bs-target="#deleteMenuModal">
                            <i class="bi bi-trash"></i> Obriši meni
                        </button>
                    </form>
                </div>
            </div>
        <% } else { %>
            <div class="no-menu-card">
                <i class="bi bi-journal-x"></i>
                <p>Trenutno nema postavljenog menija.</p>
                <button type="button" class="btn-primary" id="createMenuBtn"><i class="bi bi-plus-circle"></i> Kreiraj meni</button>
            </div>
        <% } %>
    </div>

    <div id="menuFormContainer" style="display: none;">
        <form id="menuForm" action="/canteen/menu" method="POST" enctype="multipart/form-data">
            <div class="menu-form-card">
                <div id="menuItemsContainer"></div>
                <div class="form-actions">
                    <button type="button" class="btn-primary" id="addMenuItemBtn"><i class="bi bi-plus-circle"></i> Dodaj stavku</button>
                    <div class="form-actions-right">
                        <button type="button" class="btn-secondary" id="cancelEditBtn">Otkaži</button>
                        <button type="submit" class="btn-primary"><i class="bi bi-save"></i> Sačuvaj meni</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="deleteMenuModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Potvrda brisanja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Jeste li sigurni da želite trajno obrisati ovaj meni? Ova radnja je nepovratna.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Odustani</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Obriši</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.canteenMenuData = {
        tags: <%- JSON.stringify(tags || []) %>,
        menu: <%- JSON.stringify(menu || []) %>
    };
</script>
<script src="/javascripts/canteen/menu.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                document.getElementById('deleteMenuForm').submit();
            });
        }
    });
</script>
</body>
</html>
