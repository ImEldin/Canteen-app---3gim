<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/TGS-logo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sve narudžbe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/stylesheets/shared/loadingSpinner.css">
    <link rel="stylesheet" href="/stylesheets/shared/topBar.css">
    <link rel="stylesheet" href="/stylesheets/shared/body.css">
    <link rel="stylesheet" href="/stylesheets/canteen/orders.css">
</head>
<body>
<div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
<div id="bg-fixed"></div>

<div class="top-bar">
    <div class="admin-info">
        <div class="admin-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
        <span class="admin-name"><%= user.username %></span>
    </div>
    <div class="nav-actions">
        <a href="/canteen" class="back-btn">Kantina Panel</a>
        <a href="/auth/logout" class="logout-btn">Odjavi se</a>
    </div>
</div>

<div class="canteen-orders-container">
    <div class="page-header">
        <div class="page-header-card">
            <h1 class="page-title">Sve narudžbe</h1>
        </div>
    </div>


    <% if (typeof error !== 'undefined' && error) { %>
        <div class="error-message">
            <span><%= error %></span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>
    <% if (typeof success !== 'undefined' && success) { %>
        <div class="success-message">
            <span><%= success %></span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>

    <form method="GET" class="filter-bar" autocomplete="off">
        <div class="filter-group">
            <label for="filterUsername">Korisničko ime ili email</label>
            <input type="text" id="filterUsername" name="username" class="filter-input" placeholder="Pretraži po imenu ili email-u..." value="<%= filters.username || '' %>">
        </div>

        <div class="filter-group custom-select-wrapper">
            <label for="roleSelect">Uloga</label>
            <div class="custom-select" id="roleSelect">
                <span class="selected-text">Sve uloge</span>
                <i class="bi bi-chevron-down arrow"></i>
            </div>
            <input type="hidden" name="role" id="roleInput" value="<%= filters.role || '' %>">
        </div>

        <div class="filter-group custom-select-wrapper">
            <label for="breakSelect">Odmor</label>
            <div class="custom-select" id="breakSelect">
                <span class="selected-text">Svi odmori</span>
                <i class="bi bi-chevron-down arrow"></i>
            </div>
            <input type="hidden" name="break" id="breakInput" value="<%= filters.break || '' %>">
        </div>

        <div class="filter-group custom-select-wrapper">
            <label for="sortSelect">Sortiraj</label>
            <div class="custom-select" id="sortSelect">
                <span class="selected-text">Vrijeme preuzimanja ↑</span>
                <i class="bi bi-chevron-down arrow"></i>
            </div>
            <input type="hidden" name="sort" id="sortInput" value="<%= filters.sort || 'pickup_asc' %>">
        </div>

        <div class="filter-group custom-select-wrapper">
            <label for="pageSizeSelect">Po stranici</label>
            <div class="custom-select" id="pageSizeSelect">
                <span class="selected-text"><%= pageSize %></span>
                <i class="bi bi-chevron-down arrow"></i>
            </div>
            <input type="hidden" name="pageSize" id="pageSizeInput" value="<%= pageSize %>">
        </div>

        <div class="toggle-switch-container">
            <label for="showCompleted">Prikaži završene</label>
            <label class="toggle-switch">
                <input type="checkbox" id="showCompleted" name="showCompleted" value="true" <%= filters.showCompleted ? 'checked' : '' %>>
                <span class="toggle-slider"></span>
            </label>
        </div>

        <div class="filter-actions">
            <button type="submit" class="filter-btn"><i class="bi bi-funnel-fill"></i> Filter</button>
            <a href="/canteen/orders" class="clear-btn">Očisti</a>
        </div>
    </form>

    <div class="accordion" id="breakAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingBreaks">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBreaks">
                    Pregled odmora (sumirano)
                </button>
            </h2>
            <div id="collapseBreaks" class="accordion-collapse collapse" data-bs-parent="#breakAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <div class="break-summary-card">
                                <h5><i class="bi bi-cup-straw"></i> Prvi odmor</h5>
                                <% if (breakReports.first_break.items.length === 0) { %>
                                    <p class="text-muted">Nema aktivnih narudžbi.</p>
                                <% } else { %>
                                    <table class="table table-borderless table-sm">
                                        <tbody>
                                        <% breakReports.first_break.items.forEach(item => { %>
                                            <tr>
                                                <td><%= item.item_name %></td>
                                                <td class="text-end"><strong>x<%= item.total_quantity %></strong></td>
                                                <td class="text-end"><%= Number(item.total_revenue).toFixed(2) %> KM</td>
                                            </tr>
                                        <% }) %>
                                        </tbody>
                                    </table>
                                    <div class="break-summary-footer">
                                        <strong>Ukupno: <%= Number(breakReports.first_break.total).toFixed(2) %> KM</strong>
                                        <form action="/canteen/orders/complete/first_break" method="POST">
                                            <button type="button" class="btn btn-success btn-sm btn-complete-break">Kompletiraj odmor</button>
                                        </form>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="break-summary-card">
                                <h5><i class="bi bi-cup-hot"></i> Drugi odmor</h5>
                                <% if (breakReports.second_break.items.length === 0) { %>
                                    <p class="text-muted">Nema aktivnih narudžbi.</p>
                                <% } else { %>
                                    <table class="table table-borderless table-sm">
                                        <tbody>
                                        <% breakReports.second_break.items.forEach(item => { %>
                                            <tr>
                                                <td><%= item.item_name %></td>
                                                <td class="text-end"><strong>x<%= item.total_quantity %></strong></td>
                                                <td class="text-end"><%= Number(item.total_revenue).toFixed(2) %> KM</td>
                                            </tr>
                                        <% }) %>
                                        </tbody>
                                    </table>
                                    <div class="break-summary-footer">
                                        <strong>Ukupno: <%= Number(breakReports.second_break.total).toFixed(2) %> KM</strong>
                                        <form action="/canteen/orders/complete/second_break" method="POST">
                                            <button class="btn btn-success btn-sm">Kompletiraj odmor</button>
                                        </form>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <% if (orders.length > 0) { %>
        <% orders.forEach(order => { %>
            <div class="order-card">
                <div class="order-header">
                <span class="user-info">
                    <%= order.User.username %> <span class="role"><%= order.User.role %></span>
                </span>
                    <span class="order-date"><%= new Date(order.created_at).toLocaleDateString('bs-BA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
                <div class="order-body">
                    <div class="order-details">
                        <div class="info-group">
                            <div class="info-label">Kontakt</div>
                            <div class="info-value"><i class="bi bi-envelope"></i> <%= order.User.email %></div>
                            <% if (order.User.phone_number) { %>
                                <div class="info-value"><i class="bi bi-phone"></i> <%= order.User.phone_number %></div>
                            <% } %>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Vrijeme preuzimanja</div>
                            <div class="info-value">
                                <% if (order.pickup_time) { %>
                                    <i class="bi bi-clock"></i> <%= order.pickup_time %>
                                <% } else if (order.break_slot) { %>
                                    <i class="bi bi-bell"></i> <%= order.break_slot === "first_break" ? "Prvi odmor" : "Drugi odmor" %>
                                <% } %>
                            </div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Ukupan iznos</div>
                            <div class="total-amount"><%= order.total_amount %> KM</div>
                        </div>
                    </div>
                    <div class="order-items-section">
                        <h3 class="items-list-title">Stavke narudžbe</h3>
                        <ul class="order-items-list">
                            <% order.OrderItems.forEach(item => { %>
                                <li class="order-item">
                                    <span class="item-name"><span class="quantity"><%= item.quantity %>x</span> <%= item.MenuItem.name %></span>
                                    <span class="item-price"><%= item.unit_price %> KM</span>
                                </li>
                            <% }) %>
                        </ul>
                    </div>
                </div>
                <div class="order-footer">
                    <div class="order-status <%= order.completed ? 'completed' : 'active' %>">
                        Status: <%= order.completed ? "Završeno" : "Aktivno" %>
                    </div>
                    <form action="/canteen/orders/toggle-status/<%= order.id %>" method="POST">
                        <button class="btn-toggle-status <%= order.completed ? 'completed' : 'active' %>">
                            <%= order.completed ? "Vrati na aktivno" : "Označi kao završeno" %>
                        </button>
                    </form>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <div class="no-orders-card">
            <i class="bi bi-receipt"></i>
            <p>Nema narudžbi koje odgovaraju filterima.</p>
        </div>
    <% } %>

    <div class="pagination-container">
        <nav class="pagination-controls" aria-label="Pagination">
            <a <% if (page > 1) { %>href="?<%= new URLSearchParams({ ...filters, pageSize, page: page - 1 }).toString() %>"<% } %> class="page-btn icon-btn <%= (page <= 1) ? 'disabled' : '' %>">
                <i class="bi bi-chevron-left"></i>
            </a>
            <span class="page-info">Stranica <%= page %></span>
            <a <% if (hasMore) { %>href="?<%= new URLSearchParams({ ...filters, pageSize, page: page + 1 }).toString() %>"<% } %> class="page-btn icon-btn <%= (!hasMore) ? 'disabled' : '' %>">
                <i class="bi bi-chevron-right"></i>
            </a>
        </nav>
    </div>
</div>

<div class="custom-options" id="roleOptions">
    <div class="custom-option" data-value="">Sve uloge</div>
    <div class="custom-option" data-value="ucenik">Učenik</div>
    <div class="custom-option" data-value="profesor">Profesor</div>
</div>
<div class="custom-options" id="breakOptions">
    <div class="custom-option" data-value="">Svi odmori</div>
    <div class="custom-option" data-value="first_break">Prvi odmor</div>
    <div class="custom-option" data-value="second_break">Drugi odmor</div>
    <div class="custom-option" data-value="custom">Posebno vrijeme</div>
</div>
<div class="custom-options" id="sortOptions">
    <div class="custom-option" data-value="pickup_asc">Vrijeme preuzimanja ↑</div>
    <div class="custom-option" data-value="pickup_desc">Vrijeme preuzimanja ↓</div>
    <div class="custom-option" data-value="price_asc">Cijena ↑</div>
    <div class="custom-option" data-value="price_desc">Cijena ↓</div>
</div>
<div class="custom-options" id="pageSizeOptions">
    <div class="custom-option" data-value="10">10</div>
    <div class="custom-option" data-value="20">20</div>
    <div class="custom-option" data-value="50">50</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/javascripts/canteen/orders.js"></script>
<div class="modal fade" id="completeBreakModal" tabindex="-1" aria-labelledby="completeBreakModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeBreakModalLabel">Potvrda kompletiranja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Jeste li sigurni da želite kompletirati ovaj odmor? Sve aktivne narudžbe za ovaj odmor bit će označene kao završene.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Odustani</button>
                <button type="button" class="btn btn-success" id="confirmCompleteBreakBtn">Kompletiraj</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const completeBreakModal = new bootstrap.Modal(document.getElementById('completeBreakModal'));
        const confirmCompleteBreakBtn = document.getElementById('confirmCompleteBreakBtn');
        let formToSubmit;

        document.querySelectorAll('.btn-complete-break').forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                formToSubmit = this.closest('form');
                completeBreakModal.show();
            });
        });

        confirmCompleteBreakBtn.addEventListener('click', function() {
            if (formToSubmit) {
                formToSubmit.submit();
            }
        });
    });
</script>

</body>
</html>