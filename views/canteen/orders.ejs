<h1>All Orders</h1>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .alert {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    .alert-success {
        background: #d4edda;
        color: #155724;
    }
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
    }
</style>

<!-- SUCCESS / ERROR -->
<% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
<% } %>

<% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
<% } %>


<!-- FILTER FORM -->
<form method="GET" style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">

    <input type="text" name="user" placeholder="username or email" value="<%= filters.user %>" />

    <select name="role">
        <option value="">All roles</option>
        <option value="ucenik" <%= filters.role === "ucenik" ? "selected" : "" %>>Uƒçenik</option>
        <option value="profesor" <%= filters.role === "profesor" ? "selected" : "" %>>Profesor</option>
    </select>

    <select name="break">
        <option value="">All breaks</option>
        <option value="first_break" <%= filters.break === "first_break" ? "selected" : "" %>>First break</option>
        <option value="second_break" <%= filters.break === "second_break" ? "selected" : "" %>>Second break</option>
        <option value="custom" <%= filters.break === "custom" ? "selected" : "" %>>Custom time</option>
    </select>

    <select name="sort">
        <option value="pickup_asc" <%= filters.sort === "pickup_asc" ? "selected" : "" %>>Pickup Time ‚Üë</option>
        <option value="pickup_desc" <%= filters.sort === "pickup_desc" ? "selected" : "" %>>Pickup Time ‚Üì</option>
        <option value="price_asc" <%= filters.sort === "price_asc" ? "selected" : "" %>>Price ‚Üë</option>
        <option value="price_desc" <%= filters.sort === "price_desc" ? "selected" : "" %>>Price ‚Üì</option>
    </select>

    <div class="toggle-container">
        <span>Completed</span>
        <input type="checkbox" name="completed" value="true"
                <%= filters.completed === "true" ? "checked" : "" %>
               onchange="this.form.submit()">
    </div>

    <button type="submit">Apply</button>

    <a href="/canteen/orders"><button type="button">Clear Filters</button></a>
</form>

<div class="accordion mb-4" id="breakAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingBreaks">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBreaks">
                Pregled odmora (sumirano)
            </button>
        </h2>

        <div id="collapseBreaks" class="accordion-collapse collapse" data-bs-parent="#breakAccordion">
            <div class="accordion-body">

                <!-- PRVI ODMOR -->
                <div class="border rounded p-3 mb-4">
                    <h5 class="mb-3">üìå Prvi odmor</h5>

                    <% if (breakReports.first_break.items.length === 0) { %>
                        <p class="text-muted">Nema aktivnih narud≈æbi za prvi odmor.</p>
                    <% } else { %>

                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>Artikal</th>
                                <th>Koliƒçina</th>
                                <th>Ukupno</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% breakReports.first_break.items.forEach(item => { %>
                                <tr>
                                    <td><%= item.item_name %></td>
                                    <td><%= item.total_quantity %></td>
                                    <td><%= Number(item.total_revenue).toFixed(2) %> KM</td>
                                </tr>
                            <% }) %>
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <strong>Ukupna zarada: <%= Number(breakReports.first_break.total).toFixed(2) %> KM</strong>

                            <form action="/canteen/orders/complete/first_break" method="POST">
                                <button class="btn btn-success btn-sm">Kompletiraj prvi odmor</button>
                            </form>
                        </div>
                    <% } %>
                </div>

                <!-- DRUGI ODMOR -->
                <div class="border rounded p-3">
                    <h5 class="mb-3">üìå Drugi odmor</h5>

                    <% if (breakReports.second_break.items.length === 0) { %>
                        <p class="text-muted">Nema aktivnih narud≈æbi za drugi odmor.</p>
                    <% } else { %>

                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>Artikal</th>
                                <th>Koliƒçina</th>
                                <th>Ukupno</th>
                            </tr>
                            </thead>
                            <tbody>
                            <% breakReports.second_break.items.forEach(item => { %>
                                <tr>
                                    <td><%= item.item_name %></td>
                                    <td><%= item.total_quantity %></td>
                                    <td><%= Number(item.total_revenue).toFixed(2) %> KM</td>
                                </tr>
                            <% }) %>
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <strong>Ukupna zarada: <%= Number(breakReports.second_break.total).toFixed(2) %> KM</strong>

                            <form action="/canteen/orders/complete/second_break" method="POST">
                                <button class="btn btn-success btn-sm">Kompletiraj drugi odmor</button>
                            </form>
                        </div>
                    <% } %>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- ORDER LIST -->
<% orders.forEach(order => { %>
    <div class="order-box">

        <p>
            <strong>User:</strong> <%= order.User.username %> (<%= order.User.email %>)<br>
            <strong>Phone:</strong> <%= order.User.phone_number %><br>
            <strong>Role:</strong> <%= order.User.role %>
        </p>

        <p>
            <strong>Date:</strong> <%= order.created_at.toLocaleString() %><br>

            <% if (order.pickup_time) { %>
                <strong>Pickup:</strong> <%= order.pickup_time %><br>
            <% } %>

            <% if (order.break_slot) { %>
                <strong>Break:</strong>
                <%= order.break_slot === "first_break"
                        ? "First Break (10:25 - 10:45)"
                        : "Second Break (15:40 - 16:00)" %><br>
            <% } %>

            <strong>Total:</strong> <%= order.total_amount %> KM<br>

            <strong>Status:</strong>
            <% if (order.completed) { %>
                <span style="color:green; font-weight:bold;">Completed</span>
            <% } else { %>
                <span style="color:red; font-weight:bold;">Active</span>
            <% } %>
        </p>

        <strong>Items:</strong>
        <ul class="order-items">
            <% order.OrderItems.forEach(item => { %>
                <li>
                    <%= item.quantity %>√ó <%= item.MenuItem.name %> ‚Äî <%= item.unit_price %> KM
                </li>
            <% }) %>
        </ul>

        <!-- BUTTON TO TOGGLE STATUS -->
        <form action="/canteen/orders/toggle-status/<%= order.id %>" method="POST">
            <button class="btn-status <%= order.completed ? 'completed' : '' %>">
                <%= order.completed ? "Vrati na aktivno" : "Oznaƒçi kao zavr≈°eno" %>
            </button>
        </form>

    </div>
<% }) %>

<!-- PAGINATION -->
<div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
    <%
    const queryString = Object.entries(filters)
            .filter(([k,v]) => v && v !== "")
            .map(([k,v]) => `${k}=${v}`)
            .join("&");
    %>

    <% if (page > 1) { %>
        <a href="/canteen/orders?<%= queryString %>&page=<%= page - 1 %>&pageSize=<%= pageSize %>">
            <button>Previous</button>
        </a>
    <% } else { %>
        <button disabled>Previous</button>
    <% } %>

    <% if (hasMore) { %>
        <a href="/canteen/orders?<%= queryString %>&page=<%= page + 1 %>&pageSize=<%= pageSize %>">
            <button>Next</button>
        </a>
    <% } else { %>
        <button disabled>Next</button>
    <% } %>
</div>

<a href="/canteen">Back to Dashboard</a>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
