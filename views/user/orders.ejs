<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/TGS-logo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moje narudžbe</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/stylesheets/shared/loadingSpinner.css">
    <link rel="stylesheet" href="/stylesheets/shared/topBar.css">
    <link rel="stylesheet" href="/stylesheets/shared/body.css">
    <link rel="stylesheet" href="/stylesheets/user/orders.css">
</head>
<body>
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="bg-fixed"></div>

<div class="top-bar">
    <div class="admin-info">
        <div class="admin-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
        <span class="admin-name"><%= user.username %></span>
    </div>
    <div class="nav-actions">
        <a href="/user" class="back-btn">Korisnički panel</a>
        <a href="/auth/logout" class="logout-btn">Odjavi se</a>
    </div>
</div>

<div class="orders-container">
    <div class="page-header">
        <div class="page-header-card">
            <h1 class="page-title">Moje narudžbe</h1>
            <a href="/user/menu" class="back-btn">
                 Nazad na meni
            </a>
        </div>
    </div>
    <% if (typeof error !== 'undefined' && error) { %>
        <div class="error-message">
            <span><strong>Greška!</strong> <%= error %></span>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>

    <% if (typeof success !== 'undefined' && success) { %>
        <div class="success-message">
            <span><%= success %></span>
            <button type="button" class="close-btn-success" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>
    <% if (orders.length > 0) { %>
        <% orders.forEach(order => { %>
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">Narudžba</span>
                    <span class="order-date"><%= new Date(order.created_at).toLocaleDateString('bs-BA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
                </div>
                <div class="order-body">
                    <div class="order-details">
                        <div class="pickup-info">
                            <span class="info-label">Vrijeme preuzimanja</span>
                            <span class="info-value">
                                <% if (order.pickup_time) { %>
                                    <i class="bi bi-clock"></i> <%= order.pickup_time %>
                                <% } else if (order.break_slot) { %>
                                    <i class="bi bi-bell"></i> <%= order.break_slot === "first_break" ? "Prvi odmor (10:25 - 10:45)" : "Drugi odmor (15:40 - 16:00)" %>
                                <% } %>
                            </span>
                        </div>
                        <div class="total-info">
                            <span class="info-label">Ukupan iznos</span>
                            <span class="total-amount"><%= order.total_amount %> KM</span>
                        </div>
                    </div>

                    <h3 class="items-list-title">Stavke narudžbe</h3>
                    <ul class="order-items-list">
                        <% order.OrderItems.forEach(item => { %>
                            <li class="order-item">
                                <span class="item-name"><span class="quantity"><%= item.quantity %>x</span> <%= item.MenuItem.name %></span>
                                <span class="item-price"><%= item.unit_price %> KM</span>
                            </li>
                        <% }) %>
                    </ul>
                </div>
                <div class="order-footer">
                    <form id="deleteOrderForm" action="/user/orders/<%= order.id %>/delete" method="POST">
                        <button type="button" class="btn-delete" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                            <i class="bi bi-trash"></i> Obriši
                        </button>
                    </form>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <div class="no-orders-card">
            <i class="bi bi-receipt"></i>
            <p>Nemate prethodnih narudžbi.</p>
            <a href="/user/menu" class="back-btn">Napravi prvu narudžbu</a>
        </div>
    <% } %>
</div>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Potvrda brisanja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Jeste li sigurni da želite trajno obrisati ovu narudžbu? Ova radnja je nepovratna.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Odustani</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Obriši</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    window.addEventListener('load', function() {
        document.getElementById('loading-overlay').classList.add('hidden');
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        document.getElementById('deleteOrderForm').submit();
    });
</script>
</body>
</html>
