<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/images/TGS-logo.png" type="image/png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meni</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/stylesheets/shared/loadingSpinner.css">
    <link rel="stylesheet" href="/stylesheets/shared/topBar.css">
    <link rel="stylesheet" href="/stylesheets/shared/body.css">
    <link rel="stylesheet" href="/stylesheets/user/menu.css">
</head>
<body>
<div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
</div>

<div id="bg-fixed"></div>

<div class="top-bar">
    <div class="admin-info">
        <div class="admin-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
        <span class="admin-name"><%= user.username %></span>
    </div>
    <div class="nav-actions">
        <a href="/user" class="back-btn">Korisnički panel</a>
        <a href="/auth/logout" class="logout-btn">Odjavi se</a>
    </div>
</div>

<div class="menu-container">
    <div class="page-header">
        <h1 class="page-title">Današnji meni</h1>
        <a href="/user/orders" class="back-btn">
            Moje narudžbe
        </a>
    </div>

    <div class="filters-card">
        <form id="filterForm" class="filters-form" method="GET" action="/user/menu" autocomplete="off">
            <div class="filter-group">
                <div class="search-input-wrapper">
                    <i class="bi bi-search"></i>
                    <input type="text" name="name" class="search-input" placeholder="Pretraži po nazivu..." value="<%= filters?.name || '' %>">
                </div>

                <div class="custom-select-wrapper">
                    <div class="custom-select" id="tagSelect">
                        <span class="selected-text">Sve kategorije</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="custom-options" id="tagOptions">
                        <div class="custom-option" data-value="">Sve kategorije</div>
                        <% tags.forEach(t => { %>
                            <div class="custom-option" data-value="<%= t.name %>"><%= t.name %></div>
                        <% }) %>
                    </div>
                    <input type="hidden" name="tag" id="tagInput" value="<%= filters?.tag || '' %>">
                </div>

                <div class="custom-select-wrapper">
                    <div class="custom-select" id="orderSelect">
                        <span class="selected-text">Sortiraj po</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="custom-options" id="orderOptions">
                        <div class="custom-option" data-value="">Podrazumijevano</div>
                        <div class="custom-option" data-value="price_asc">Cijena: niža → viša</div>
                        <div class="custom-option" data-value="price_desc">Cijena: viša → niža</div>
                    </div>
                    <input type="hidden" name="order" id="orderInput" value="<%= filters?.order || '' %>">
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn-filter"><i class="bi bi-funnel-fill"></i> Filter</button>
                <a href="/user/menu" class="btn-clear">Poništi</a>
            </div>
        </form>
    </div>

    <% if (typeof error !== "undefined" && error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= error %>
            <button type="button" class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>
    <% } %>

    <div class="menu-layout">
        <div class="menu-items-grid">
            <% if (menu.length > 0) { %>
                <% menu.forEach(function(item) { %>
                    <div class="menu-item-card">
                        <div class="item-image-container">
                            <img src="<%= item.image_url %>" alt="<%= item.name %>" class="item-image" onerror="this.onerror=null;this.src='/images/default-food.png'; this.classList.add('is-default');">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name"><%= item.name %></h3>
                            <h3 class="item-description"><%= item.description %></h3>
                            <div class="item-footer">
                                <p class="item-price"><%= item.price %> KM</p>
                                <a href="/user/menu/add/<%= item.id %>" class="btn-add-cart">
                                    <i class="fas fa-cart-plus"></i> Dodaj u korpu
                                </a>
                            </div>
                        </div>
                    </div>

                <% }); %>
            <% } else { %>
                <p class="no-results">Nema stavki koje odgovaraju vašoj pretrazi.</p>
            <% } %>
        </div>

        <div class="cart-sidebar">
            <div class="cart-card">
                <h2 class="cart-title">Vaša korpa</h2>

                <% if (!cart || cart.length === 0) { %>
                    <div class="empty-cart">
                        <i class="bi bi-cart-x"></i>
                        <p>Korpa je prazna</p>
                    </div>
                <% } else { %>

                    <ul class="cart-items-list">
                        <% cart.forEach(function(c) { %>
                            <li class="cart-item">
                                <span class="cart-item-name"><%= c.name %> (<%= c.quantity %>x)</span>
                                <div class="cart-item-details">
                                    <span class="cart-item-price"><%= (c.price * c.quantity).toFixed(2) %> KM</span>
                                    <a href="/user/menu/remove/<%= c.id %>" class="cart-item-remove" title="Ukloni"><i class="fas fa-times"></i></a>
                                </div>
                            </li>
                        <% }); %>
                    </ul>

                    <div class="cart-total">
                        <span>Ukupno:</span>
                        <span><%= total.toFixed(2) %> KM</span>
                    </div>

                    <form action="/user/menu/confirm" method="POST" class="order-form">
                        <h3 class="pickup-title">Opcija preuzimanja</h3>

                        <div class="pickup-options">
                            <div class="radio-group">
                                <input type="radio" id="pickup_break" name="pickupMode" value="break" onclick="enableBreak()">
                                <label for="pickup_break">Preuzimanje na odmoru</label>
                            </div>

                            <div class="radio-group">
                                <input type="radio" id="pickup_time_radio" name="pickupMode" value="time" onclick="enableTime()">
                                <label for="pickup_time_radio">Odaberi vrijeme</label>
                            </div>
                        </div>

                        <div id="break_select_wrapper" class="custom-select-wrapper" style="display: none;">
                            <div class="custom-select" id="breakSlotSelect">
                                <span class="selected-text">Odaberi veliki odmor</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div class="custom-options" id="breakSlotOptions">
                                <div class="custom-option" data-value="first_break">Prvi odmor (10:25 - 10:45)</div>
                                <div class="custom-option" data-value="second_break">Drugi odmor (15:40 - 16:00)</div>
                            </div>
                            <input type="hidden" name="break_slot" id="break_slot">
                        </div>

                        <input type="time" name="pickup_time" id="pickup_time" class="form-control" min="08:00" max="16:00" style="display: none;">

                        <button type="submit" class="btn-confirm-order">Potvrdi narudžbu</button>
                    </form>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/javascripts/user/menu.js"></script>
<script>
    window.addEventListener('load', function() {
        document.getElementById('loading-overlay').classList.add('hidden');
    });

</script>
</body>
</html>
